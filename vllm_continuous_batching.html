<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Static vs Continuous Batching</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: #0d1117; color: #e6edf3; min-height: 100vh; padding: 24px; }
  h1 { text-align: center; font-size: 1.5rem; margin-bottom: 6px; color: #58a6ff; }
  .subtitle { text-align: center; color: #8b949e; margin-bottom: 20px; font-size: 0.85rem; }
  .container { max-width: 960px; margin: 0 auto; }

  .controls { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  .btn { padding: 8px 16px; border-radius: 6px; border: 1px solid #30363d; background: #21262d; color: #e6edf3; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.15s; user-select: none; display: inline-flex; align-items: center; gap: 5px; }
  .btn:hover { background: #30363d; }
  .btn.primary { background: #238636; border-color: #2ea043; }
  .btn.primary:hover { background: #2ea043; }
  .btn.play { background: #1f6feb; border-color: #388bfd; }
  .btn.play:hover { background: #388bfd; }
  .btn.stop { background: #9e1c23; border-color: #f85149; }
  .btn.stop:hover { background: #b62324; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn svg { width: 14px; height: 14px; fill: currentColor; }
  .step-label { color: #8b949e; font-size: 0.85rem; flex: 1; text-align: right; }
  .speed-control { display: flex; align-items: center; gap: 6px; color: #8b949e; font-size: 0.75rem; }
  .speed-control select { background: #161b22; color: #c9d1d9; border: 1px solid #30363d; border-radius: 4px; padding: 4px 6px; font-size: 0.75rem; cursor: pointer; }

  .progress-bar { display: flex; gap: 3px; margin-bottom: 16px; }
  .progress-dot { flex: 1; height: 4px; border-radius: 2px; background: #21262d; transition: background 0.3s; }
  .progress-dot.done { background: #238636; }
  .progress-dot.current { background: #58a6ff; }

  .narration { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px 20px; margin-bottom: 16px; min-height: 64px; }
  .narration .step-title { display: block; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; color: #58a6ff; margin-bottom: 6px; }
  .narration .step-body { display: block; font-size: 0.88rem; line-height: 1.6; color: #c9d1d9; }
  .narration .step-body .hl { color: #58a6ff; font-weight: 600; }
  .narration .step-body .yellow { color: #e3b341; font-weight: 600; }
  .narration .step-body .green { color: #3fb950; font-weight: 600; }
  .narration .step-body .red { color: #f85149; font-weight: 600; }

  .batching-section { margin-bottom: 16px; background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; }
  .section-title { font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 12px; text-align: center; }
  .static-title { color: #f85149; }
  .continuous-title { color: #3fb950; }

  .timeline { display: flex; align-items: center; margin: 8px 0; min-height: 48px; }
  .time-label { width: 70px; font-weight: 700; font-size: 0.75rem; color: #8b949e; flex-shrink: 0; }
  .batch-container { flex: 1; height: 42px; background: #0d1117; border-radius: 6px; position: relative; margin-left: 8px; border: 2px solid #21262d; display: flex; align-items: center; gap: 4px; padding: 0 6px; overflow: hidden; }

  .request { height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.7rem; border: 2px solid transparent; padding: 0 8px; flex-shrink: 0; transition: all 0.4s ease; }
  .req-1 { background: #1a0a2e; border-color: #8957e5; color: #a371f7; }
  .req-2 { background: #122d1e; border-color: #2ea043; color: #3fb950; }
  .req-3 { background: #0c2d48; border-color: #388bfd; color: #58a6ff; }
  .req-4 { background: #2a1d00; border-color: #d29922; color: #e3b341; }
  .req-5 { background: #2d0a1e; border-color: #da3633; color: #f85149; }
  .req-done { background: #161b22; border-color: #21262d; color: #484f58; text-decoration: line-through; opacity: 0.5; }

  .idle-badge { background: #2d0a1e; border: 1px solid #da3633; color: #f85149; padding: 4px 12px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); }

  .gpu-utilization { display: flex; align-items: center; margin-top: 10px; }
  .util-label { width: 70px; font-size: 0.7rem; font-weight: 700; color: #8b949e; text-transform: uppercase; }
  .util-bar { flex: 1; height: 16px; background: #0d1117; border-radius: 8px; overflow: hidden; margin-left: 8px; border: 1px solid #21262d; }
  .util-fill { height: 100%; border-radius: 8px; transition: width 0.4s ease; }
  .util-fill.static-fill { background: linear-gradient(90deg, #da3633, #f85149); }
  .util-fill.continuous-fill { background: linear-gradient(90deg, #238636, #3fb950); }
  .util-value { margin-left: 8px; font-weight: 800; font-size: 0.85rem; min-width: 36px; }
  .util-value.red { color: #f85149; }
  .util-value.green { color: #3fb950; }

  .metrics-bar { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
  .metric { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 10px 16px; flex: 1; min-width: 120px; text-align: center; }
  .metric-label { font-size: 0.65rem; color: #8b949e; text-transform: uppercase; letter-spacing: 0.04em; }
  .metric-value { font-size: 1.2rem; font-weight: 800; margin-top: 2px; }
  .metric-value.red { color: #f85149; }
  .metric-value.green { color: #3fb950; }
  .metric-value.blue { color: #58a6ff; }

  .explanation { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; }
  .explanation h3 { margin-top: 0; margin-bottom: 10px; color: #58a6ff; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.04em; }
  .explanation p { font-size: 0.85rem; line-height: 1.6; color: #c9d1d9; margin-bottom: 8px; }
</style>
</head>
<body>

<div class="container">
  <h1>Static vs Continuous Batching</h1>
  <p class="subtitle">How vLLM maximizes GPU utilization with iteration-level scheduling</p>

  <div class="controls">
    <button class="btn" id="prevBtn" onclick="go(-1)">
      <svg viewBox="0 0 16 16"><path d="M9.78 12.78a.75.75 0 01-1.06 0L4.47 8.53a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L6.06 8l3.72 3.72a.75.75 0 010 1.06z"/></svg>
      Prev
    </button>
    <button class="btn primary" id="nextBtn" onclick="go(1)">
      Next
      <svg viewBox="0 0 16 16"><path d="M6.22 3.22a.75.75 0 011.06 0l4.25 4.25a.75.75 0 010 1.06l-4.25 4.25a.75.75 0 01-1.06-1.06L9.94 8 6.22 4.28a.75.75 0 010-1.06z"/></svg>
    </button>
    <button class="btn play" id="playBtn" onclick="togglePlay()">
      <svg id="playIcon" viewBox="0 0 16 16"><path d="M4 2l10 6-10 6z"/></svg>
      <svg id="stopIcon" viewBox="0 0 16 16" style="display:none"><rect x="3" y="3" width="10" height="10" rx="1"/></svg>
      <span id="playLabelEl">Play</span>
    </button>
    <div class="speed-control">
      <label for="speedSel">Speed:</label>
      <select id="speedSel">
        <option value="3000">Slow</option>
        <option value="1800" selected>Normal</option>
        <option value="1000">Fast</option>
      </select>
    </div>
    <span class="step-label" id="stepLabel">Step 0 / 6</span>
  </div>

  <div class="progress-bar" id="progressBar"></div>

  <div class="narration" id="narration">
    <span class="step-title">Getting Started</span>
    <span class="step-body">Click <span class="hl">Next</span> to step through, or <span class="hl">Play</span> to auto-advance.</span>
  </div>

  <!-- STATIC BATCHING -->
  <div class="batching-section">
    <div class="section-title static-title">Static Batching</div>
    <div class="timeline">
      <div class="time-label">T1 (0-4s)</div>
      <div class="batch-container" id="static-t1"></div>
    </div>
    <div class="timeline">
      <div class="time-label">T2 (4-8s)</div>
      <div class="batch-container" id="static-t2"></div>
    </div>
    <div class="timeline">
      <div class="time-label">T3 (8-12s)</div>
      <div class="batch-container" id="static-t3"></div>
    </div>
    <div class="timeline">
      <div class="time-label">T4 (12-16s)</div>
      <div class="batch-container" id="static-t4"></div>
    </div>
    <div class="gpu-utilization">
      <div class="util-label">GPU</div>
      <div class="util-bar"><div class="util-fill static-fill" id="static-util" style="width:0%"></div></div>
      <div class="util-value red" id="static-percent">0%</div>
    </div>
  </div>

  <!-- CONTINUOUS BATCHING -->
  <div class="batching-section">
    <div class="section-title continuous-title">Continuous Batching (vLLM)</div>
    <div class="timeline">
      <div class="time-label">T1 (0-4s)</div>
      <div class="batch-container" id="cont-t1"></div>
    </div>
    <div class="timeline">
      <div class="time-label">T2 (4-8s)</div>
      <div class="batch-container" id="cont-t2"></div>
    </div>
    <div class="timeline">
      <div class="time-label">T3 (8-12s)</div>
      <div class="batch-container" id="cont-t3"></div>
    </div>
    <div class="timeline">
      <div class="time-label">T4 (12-16s)</div>
      <div class="batch-container" id="cont-t4"></div>
    </div>
    <div class="gpu-utilization">
      <div class="util-label">GPU</div>
      <div class="util-bar"><div class="util-fill continuous-fill" id="cont-util" style="width:0%"></div></div>
      <div class="util-value green" id="cont-percent">0%</div>
    </div>
  </div>

  <div class="metrics-bar">
    <div class="metric">
      <div class="metric-label">Static Throughput</div>
      <div class="metric-value red" id="m-static">--</div>
    </div>
    <div class="metric">
      <div class="metric-label">Continuous Throughput</div>
      <div class="metric-value green" id="m-cont">--</div>
    </div>
    <div class="metric">
      <div class="metric-label">Improvement</div>
      <div class="metric-value blue" id="m-improve">--</div>
    </div>
  </div>

  <div class="explanation">
    <h3>Key Differences</h3>
    <p><strong>Static Batching:</strong> Waits for batches to fill completely before processing, leading to GPU idle time and lower utilization (~50%).</p>
    <p><strong>Continuous Batching:</strong> Dynamically adds/removes requests at the token level, keeping GPU constantly busy with ~95% utilization and 2-4x higher throughput.</p>
    <p><strong>Integration with PagedAttention:</strong> The dynamic nature of continuous batching requires flexible memory management, which PagedAttention provides through fine-grained, non-fragmented memory allocation.</p>
  </div>
</div>

<script>
var currentStep = 0;
var MAX = 6;
var playing = false;
var playTimer = null;

// Static batching state per step: [t1, t2, t3, t4], each entry is array of {cls, text} or 'idle'
var staticSteps = [
  // Step 0: empty
  [[], [], [], []],
  // Step 1: T1 idle waiting for batch
  ['idle', [], [], []],
  // Step 2: T2 batch 1 processes (Req 1,2,3)
  ['idle', [{c:'req-1',t:'Req 1'},{c:'req-2',t:'Req 2'},{c:'req-3',t:'Req 3'}], [], []],
  // Step 3: T3 idle waiting for next batch
  ['idle', [{c:'req-1',t:'Req 1'},{c:'req-2',t:'Req 2'},{c:'req-3',t:'Req 3'}], 'idle', []],
  // Step 4: T4 batch 2 processes (Req 4,5)
  ['idle', [{c:'req-1',t:'Req 1'},{c:'req-2',t:'Req 2'},{c:'req-3',t:'Req 3'}], 'idle', [{c:'req-4',t:'Req 4'},{c:'req-5',t:'Req 5'}]],
  // Step 5: same as step 4 (final state)
  ['idle', [{c:'req-1',t:'Req 1'},{c:'req-2',t:'Req 2'},{c:'req-3',t:'Req 3'}], 'idle', [{c:'req-4',t:'Req 4'},{c:'req-5',t:'Req 5'}]],
  // Step 6: same as step 5 (takeaway)
  ['idle', [{c:'req-1',t:'Req 1'},{c:'req-2',t:'Req 2'},{c:'req-3',t:'Req 3'}], 'idle', [{c:'req-4',t:'Req 4'},{c:'req-5',t:'Req 5'}]]
];

var contSteps = [
  // Step 0: empty
  [[], [], [], []],
  // Step 1: T1 Req 1 starts immediately
  [[{c:'req-1',t:'Req 1'}], [], [], []],
  // Step 2: T2 Req 1 continues, Req 2 added
  [[{c:'req-1',t:'Req 1'}], [{c:'req-1',t:'Req 1'},{c:'req-2',t:'Req 2'}], [], []],
  // Step 3: T3 Req 1 done, Req 2 continues, Req 3 added
  [[{c:'req-1',t:'Req 1'}], [{c:'req-1',t:'Req 1'},{c:'req-2',t:'Req 2'}], [{c:'req-2',t:'Req 2'},{c:'req-3',t:'Req 3'}], []],
  // Step 4: T4 Req 2 done, Req 3 continues, Req 4,5 added
  [[{c:'req-1',t:'Req 1'}], [{c:'req-1',t:'Req 1'},{c:'req-2',t:'Req 2'}], [{c:'req-2',t:'Req 2'},{c:'req-3',t:'Req 3'}], [{c:'req-3',t:'Req 3'},{c:'req-4',t:'Req 4'},{c:'req-5',t:'Req 5'}]],
  // Step 5: same final state
  [[{c:'req-1',t:'Req 1'}], [{c:'req-1',t:'Req 1'},{c:'req-2',t:'Req 2'}], [{c:'req-2',t:'Req 2'},{c:'req-3',t:'Req 3'}], [{c:'req-3',t:'Req 3'},{c:'req-4',t:'Req 4'},{c:'req-5',t:'Req 5'}]],
  // Step 6: same final state (takeaway)
  [[{c:'req-1',t:'Req 1'}], [{c:'req-1',t:'Req 1'},{c:'req-2',t:'Req 2'}], [{c:'req-2',t:'Req 2'},{c:'req-3',t:'Req 3'}], [{c:'req-3',t:'Req 3'},{c:'req-4',t:'Req 4'},{c:'req-5',t:'Req 5'}]]
];

var staticUtils = [0, 0, 25, 25, 50, 50, 50];
var contUtils = [0, 25, 50, 75, 95, 95, 95];

var narrations = [
  ['Getting Started',
   'Click <span class="hl">Next</span> to step through, or <span class="hl">Play</span> to auto-advance. We compare how Static and Continuous batching schedule 5 requests over 4 time slots.'],
  ['Step 1 — Requests Arrive',
   'Static batching: GPU sits <span class="red">IDLE</span> waiting for enough requests to fill a batch. Continuous batching: <span class="green">immediately starts</span> processing Req 1 as soon as it arrives — zero waiting.'],
  ['Step 2 — First Processing Window',
   'Static: finally has enough requests — processes Req 1, 2, 3 as a fixed batch. Continuous: <span class="green">dynamically adds Req 2</span> alongside Req 1 mid-iteration. GPU never sits idle.'],
  ['Step 3 — Between Batches',
   'Static: batch 1 finishes, GPU goes <span class="red">IDLE again</span> waiting for the next batch to fill. Continuous: Req 1 finishes but Req 2 continues, and <span class="green">Req 3 joins immediately</span>. No downtime.'],
  ['Step 4 — Final Processing',
   'Static: batch 2 finally starts with Req 4, 5. Continuous: Req 2 finishes, Req 3 continues, <span class="green">Req 4 and 5 join instantly</span>. All 5 requests processed in less total time.'],
  ['Step 5 — Utilization Comparison',
   'Static batching: <span class="red">~50% GPU utilization</span> — half the time spent waiting. Continuous batching: <span class="green">~95% GPU utilization</span> — the GPU is almost always doing useful work.'],
  ['Step 6 — Key Takeaways',
   'Continuous batching delivers <span class="green">2x higher throughput</span> by: ① processing requests immediately on arrival, ② adding/removing requests at <span class="hl">token-level granularity</span>, and ③ eliminating idle gaps between batches.']
];

function renderTimeline(prefix, stepsData) {
  var ids = [prefix + '-t1', prefix + '-t2', prefix + '-t3', prefix + '-t4'];
  var data = stepsData[currentStep];
  for (var i = 0; i < 4; i++) {
    var el = document.getElementById(ids[i]);
    el.innerHTML = '';
    var slot = data[i];
    if (slot === 'idle') {
      var badge = document.createElement('div');
      badge.className = 'idle-badge';
      badge.textContent = 'GPU IDLE';
      el.appendChild(badge);
    } else if (slot && slot.length > 0) {
      for (var j = 0; j < slot.length; j++) {
        var req = document.createElement('div');
        req.className = 'request ' + slot[j].c;
        req.textContent = slot[j].t;
        el.appendChild(req);
      }
    }
  }
}

function render() {
  renderTimeline('static', staticSteps);
  renderTimeline('cont', contSteps);

  // Utilization bars
  var su = staticUtils[currentStep];
  var cu = contUtils[currentStep];
  document.getElementById('static-util').style.width = su + '%';
  document.getElementById('static-percent').textContent = su + '%';
  document.getElementById('cont-util').style.width = cu + '%';
  document.getElementById('cont-percent').textContent = cu + '%';

  // Metrics
  if (currentStep >= 5) {
    document.getElementById('m-static').textContent = '2.4x';
    document.getElementById('m-cont').textContent = '4.8x';
    document.getElementById('m-improve').textContent = '2.0x';
  } else {
    document.getElementById('m-static').textContent = '--';
    document.getElementById('m-cont').textContent = '--';
    document.getElementById('m-improve').textContent = '--';
  }

  // Narration
  var n = narrations[currentStep];
  document.getElementById('narration').innerHTML =
    '<span class="step-title">' + n[0] + '</span><span class="step-body">' + n[1] + '</span>';

  // Progress bar
  var pEl = document.getElementById('progressBar');
  pEl.innerHTML = '';
  for (var i = 0; i <= MAX; i++) {
    var dot = document.createElement('div');
    dot.className = 'progress-dot';
    if (i < currentStep) dot.className += ' done';
    else if (i === currentStep) dot.className += ' current';
    pEl.appendChild(dot);
  }

  // Button states
  document.getElementById('stepLabel').textContent = 'Step ' + currentStep + ' / ' + MAX;
  document.getElementById('prevBtn').disabled = (currentStep <= 0);
  document.getElementById('nextBtn').disabled = (currentStep >= MAX);
}

function go(dir) {
  var next = currentStep + dir;
  if (next < 0) next = 0;
  if (next > MAX) next = MAX;
  currentStep = next;
  render();
}

function togglePlay() {
  playing = !playing;
  updatePlayBtn();
  if (playing) playTick();
  else clearTimeout(playTimer);
}

function playTick() {
  if (!playing) return;
  if (currentStep >= MAX) { playing = false; updatePlayBtn(); return; }
  currentStep++;
  render();
  var speed = parseInt(document.getElementById('speedSel').value, 10);
  playTimer = setTimeout(playTick, speed);
}

function updatePlayBtn() {
  document.getElementById('playIcon').style.display = playing ? 'none' : '';
  document.getElementById('stopIcon').style.display = playing ? '' : 'none';
  document.getElementById('playLabelEl').textContent = playing ? 'Stop' : 'Play';
  var btn = document.getElementById('playBtn');
  if (playing) { btn.classList.remove('play'); btn.classList.add('stop'); }
  else { btn.classList.remove('stop'); btn.classList.add('play'); }
}

render();
</script>
</body>
</html>
